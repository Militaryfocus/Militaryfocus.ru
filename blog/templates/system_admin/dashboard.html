{% extends "base.html" %}

{% block title %}Системная панель - МойБлог{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3">
        <i class="fas fa-server me-2 text-success"></i>Системная панель управления
    </h1>
    <div>
        <a href="{{ url_for('system_admin.system_settings') }}" class="btn btn-outline-primary me-2">
            <i class="fas fa-cog me-2"></i>Настройки
        </a>
        <a href="{{ url_for('system_admin.export_system_report') }}" class="btn btn-info">
            <i class="fas fa-download me-2"></i>Экспорт отчета
        </a>
    </div>
</div>

<!-- Общий статус системы -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card {% if monitoring_data.system_health.status == 'healthy' %}border-success{% elif monitoring_data.system_health.status == 'warning' %}border-warning{% else %}border-danger{% endif %}">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        {% if monitoring_data.system_health.status == 'healthy' %}
                            <i class="fas fa-check-circle fa-3x text-success"></i>
                        {% elif monitoring_data.system_health.status == 'warning' %}
                            <i class="fas fa-exclamation-triangle fa-3x text-warning"></i>
                        {% else %}
                            <i class="fas fa-times-circle fa-3x text-danger"></i>
                        {% endif %}
                    </div>
                    <div>
                        <h4 class="mb-1">
                            Статус системы: 
                            {% if monitoring_data.system_health.status == 'healthy' %}
                                <span class="text-success">Здорова</span>
                            {% elif monitoring_data.system_health.status == 'warning' %}
                                <span class="text-warning">Предупреждение</span>
                            {% else %}
                                <span class="text-danger">Критическое</span>
                            {% endif %}
                        </h4>
                        <p class="mb-0">
                            Рейтинг здоровья: {{ monitoring_data.system_health.score }}/100 | 
                            CPU: {{ "%.1f"|format(monitoring_data.system_health.cpu_usage) }}% | 
                            RAM: {{ "%.1f"|format(monitoring_data.system_health.memory_usage) }}% | 
                            Диск: {{ "%.1f"|format(monitoring_data.system_health.disk_usage) }}%
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Быстрые действия -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card bg-primary text-white h-100">
            <div class="card-body text-center">
                <i class="fas fa-shield-alt fa-2x mb-2"></i>
                <h6>Отказоустойчивость</h6>
                <p class="small mb-3">
                    {% if system_metrics.health_status.overall_status == 'healthy' %}
                        Система стабильна
                    {% else %}
                        Требует внимания
                    {% endif %}
                </p>
                <a href="{{ url_for('system_admin.fault_tolerance_panel') }}" class="btn btn-light btn-sm">
                    Управление
                </a>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card bg-success text-white h-100">
            <div class="card-body text-center">
                <i class="fas fa-search fa-2x mb-2"></i>
                <h6>SEO Оптимизация</h6>
                <p class="small mb-3">
                    {{ seo_stats.total_posts }} постов для анализа
                </p>
                <a href="{{ url_for('system_admin.seo_optimizer_panel') }}" class="btn btn-light btn-sm">
                    Оптимизировать
                </a>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card bg-info text-white h-100">
            <div class="card-body text-center">
                <i class="fas fa-link fa-2x mb-2"></i>
                <h6>Перелинковка</h6>
                <p class="small mb-3">
                    {{ "%.1f"|format(interlink_stats.coverage_percentage) }}% покрытие
                </p>
                <a href="{{ url_for('system_admin.interlinking_panel') }}" class="btn btn-light btn-sm">
                    Настроить
                </a>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card bg-warning text-white h-100">
            <div class="card-body text-center">
                <i class="fas fa-chart-line fa-2x mb-2"></i>
                <h6>Мониторинг</h6>
                <p class="small mb-3">
                    {{ monitoring_data.active_alerts|length }} активных уведомлений
                </p>
                <a href="{{ url_for('system_admin.monitoring_panel') }}" class="btn btn-light btn-sm">
                    Просмотр
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Детальная статистика -->
<div class="row">
    <!-- Отказоустойчивость -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-shield-alt me-2"></i>Отказоустойчивость
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6">
                        <h6>Здоровье сервисов</h6>
                        <div class="mb-2">
                            {% for service, status in system_metrics.health_status.checks.items() %}
                            <div class="d-flex justify-content-between">
                                <span>{{ service }}</span>
                                {% if status.status == 'healthy' %}
                                    <span class="badge bg-success">OK</span>
                                {% elif status.status == 'error' %}
                                    <span class="badge bg-danger">Ошибка</span>
                                {% else %}
                                    <span class="badge bg-warning">Предупреждение</span>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="col-6">
                        <h6>Автоматические выключатели</h6>
                        {% for cb_name, cb_info in system_metrics.circuit_breakers.items() %}
                        <div class="d-flex justify-content-between">
                            <span>{{ cb_name }}</span>
                            {% if cb_info.state == 'CLOSED' %}
                                <span class="badge bg-success">Закрыт</span>
                            {% elif cb_info.state == 'OPEN' %}
                                <span class="badge bg-danger">Открыт</span>
                            {% else %}
                                <span class="badge bg-warning">Полуоткрыт</span>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                
                <hr>
                
                <div class="row">
                    <div class="col-6">
                        <h6>Резервные копии</h6>
                        <p class="mb-1">
                            <strong>Всего:</strong> {{ system_metrics.backup_info.total_backups or 0 }}
                        </p>
                        {% if system_metrics.backup_info.latest_backups %}
                        <small class="text-muted">
                            Последняя: {{ system_metrics.backup_info.latest_backups[0].created[:10] if system_metrics.backup_info.latest_backups else 'Нет' }}
                        </small>
                        {% endif %}
                    </div>
                    <div class="col-6">
                        <form method="POST" action="{{ url_for('system_admin.create_backup') }}" class="d-inline">
                            <input type="hidden" name="backup_type" value="database">
                            <button type="submit" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-database me-1"></i>Создать резервную копию
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- SEO и перелинковка -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-search me-2"></i>SEO и перелинковка
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6">
                        <h6>SEO статистика</h6>
                        <p class="mb-1">
                            <strong>Всего постов:</strong> {{ seo_stats.total_posts }}
                        </p>
                        <p class="mb-1">
                            <strong>С мета-тегами:</strong> {{ seo_stats.posts_with_meta }}
                        </p>
                        <p class="mb-1">
                            <strong>Средний SEO рейтинг:</strong> {{ seo_stats.avg_seo_score }}
                        </p>
                        <div class="mt-2">
                            <form method="POST" action="{{ url_for('system_admin.update_sitemap') }}" class="d-inline">
                                <button type="submit" class="btn btn-outline-success btn-sm">
                                    <i class="fas fa-sitemap me-1"></i>Обновить Sitemap
                                </button>
                            </form>
                        </div>
                    </div>
                    <div class="col-6">
                        <h6>Перелинковка</h6>
                        <p class="mb-1">
                            <strong>Покрытие:</strong> {{ "%.1f"|format(interlink_stats.coverage_percentage) }}%
                        </p>
                        <p class="mb-1">
                            <strong>Всего ссылок:</strong> {{ interlink_stats.total_internal_links }}
                        </p>
                        <p class="mb-1">
                            <strong>Среднее на пост:</strong> {{ interlink_stats.average_links_per_post }}
                        </p>
                        <div class="mt-2">
                            <form method="POST" action="{{ url_for('system_admin.update_all_interlinks') }}" class="d-inline">
                                <button type="submit" class="btn btn-outline-info btn-sm">
                                    <i class="fas fa-link me-1"></i>Обновить ссылки
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Мониторинг и производительность -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>Мониторинг производительности
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <div class="text-center">
                            <div class="progress mb-2" style="height: 20px;">
                                <div class="progress-bar bg-primary" style="width: {{ monitoring_data.system_health.cpu_usage }}%">
                                    {{ "%.1f"|format(monitoring_data.system_health.cpu_usage) }}%
                                </div>
                            </div>
                            <small class="text-muted">CPU использование</small>
                        </div>
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <div class="text-center">
                            <div class="progress mb-2" style="height: 20px;">
                                <div class="progress-bar bg-success" style="width: {{ monitoring_data.system_health.memory_usage }}%">
                                    {{ "%.1f"|format(monitoring_data.system_health.memory_usage) }}%
                                </div>
                            </div>
                            <small class="text-muted">Память</small>
                        </div>
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <div class="text-center">
                            <div class="progress mb-2" style="height: 20px;">
                                <div class="progress-bar bg-warning" style="width: {{ monitoring_data.system_health.disk_usage }}%">
                                    {{ "%.1f"|format(monitoring_data.system_health.disk_usage) }}%
                                </div>
                            </div>
                            <small class="text-muted">Диск</small>
                        </div>
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <div class="text-center">
                            <h4 class="mb-1 text-primary">{{ monitoring_data.database_stats.total_posts }}</h4>
                            <small class="text-muted">Всего постов</small>
                        </div>
                    </div>
                </div>
                
                {% if monitoring_data.active_alerts %}
                <hr>
                <div class="alert alert-warning">
                    <h6><i class="fas fa-exclamation-triangle me-2"></i>Активные уведомления:</h6>
                    {% for alert in monitoring_data.active_alerts %}
                    <div class="mb-1">
                        <strong>{{ alert.rule_name }}:</strong> {{ alert.message }}
                        <small class="text-muted">({{ alert.timestamp[:16] }})</small>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                
                <div class="text-center mt-3">
                    <button type="button" class="btn btn-primary me-2" onclick="runPerformanceTest('database')">
                        <i class="fas fa-database me-2"></i>Тест БД
                    </button>
                    <button type="button" class="btn btn-success me-2" onclick="runPerformanceTest('ai_generation')">
                        <i class="fas fa-robot me-2"></i>Тест ИИ
                    </button>
                    <a href="{{ url_for('system_admin.system_logs') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-file-alt me-2"></i>Просмотр логов
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно результатов теста -->
<div class="modal fade" id="testResultModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Результат теста производительности</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="testResultContent">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Выполнение теста...</span>
                        </div>
                        <p class="mt-2">Выполняется тест...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function runPerformanceTest(testType) {
    const modal = new bootstrap.Modal(document.getElementById('testResultModal'));
    modal.show();
    
    // Сброс содержимого
    document.getElementById('testResultContent').innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Выполнение теста...</span>
            </div>
            <p class="mt-2">Выполняется тест ${testType}...</p>
        </div>
    `;
    
    // Отправка запроса
    const formData = new FormData();
    formData.append('test_type', testType);
    
    fetch('{{ url_for("system_admin.performance_test") }}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const result = data.result;
            document.getElementById('testResultContent').innerHTML = `
                <div class="alert alert-success">
                    <h6><i class="fas fa-check-circle me-2"></i>Тест ${result.test_type} завершен</h6>
                    <ul class="mb-0">
                        <li><strong>Время выполнения:</strong> ${result.duration} сек</li>
                        ${result.queries_count ? `<li><strong>Количество запросов:</strong> ${result.queries_count}</li>` : ''}
                        ${result.avg_query_time ? `<li><strong>Среднее время запроса:</strong> ${result.avg_query_time} сек</li>` : ''}
                        ${result.content_length ? `<li><strong>Длина контента:</strong> ${result.content_length} символов</li>` : ''}
                        ${result.quality_score ? `<li><strong>Качество контента:</strong> ${(result.quality_score * 100).toFixed(1)}%</li>` : ''}
                    </ul>
                </div>
            `;
        } else {
            document.getElementById('testResultContent').innerHTML = `
                <div class="alert alert-danger">
                    <h6><i class="fas fa-exclamation-triangle me-2"></i>Ошибка теста</h6>
                    <p class="mb-0">${data.error}</p>
                </div>
            `;
        }
    })
    .catch(error => {
        document.getElementById('testResultContent').innerHTML = `
            <div class="alert alert-danger">
                <h6><i class="fas fa-exclamation-triangle me-2"></i>Ошибка запроса</h6>
                <p class="mb-0">${error.message}</p>
            </div>
        `;
    });
}

// Автообновление данных каждые 30 секунд
setInterval(() => {
    fetch('{{ url_for("system_admin.monitoring_api") }}')
        .then(response => response.json())
        .then(data => {
            // Обновление индикаторов производительности
            updateProgressBar('cpu', data.system_health.cpu_usage);
            updateProgressBar('memory', data.system_health.memory_usage);
            updateProgressBar('disk', data.system_health.disk_usage);
        })
        .catch(error => console.error('Error updating monitoring data:', error));
}, 30000);

function updateProgressBar(type, value) {
    const progressBar = document.querySelector(`.progress-bar.bg-${type === 'cpu' ? 'primary' : type === 'memory' ? 'success' : 'warning'}`);
    if (progressBar) {
        progressBar.style.width = value + '%';
        progressBar.textContent = value.toFixed(1) + '%';
    }
}
</script>
{% endblock %}